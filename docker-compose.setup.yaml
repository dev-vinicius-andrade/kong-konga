version: "3.9"

services:
  kong-migrations:
    command: kong migrations bootstrap --help
    build:
      context: setup/
      target: kong-migrations
      no_cache: true
    depends_on:
      db:
        condition: service_started
      setup-database:
        condition: service_completed_successfully
    env_file:
      - ./.env.local
    networks:
      - kong-net
    restart: on-failure
    profiles:
      - setup
    stdin_open: true
    tty: true
  kong:
    depends_on:
      db:
        condition: service_started
      kong-migrations:
        condition: service_completed_successfully
    networks:
      - kong-net
    profiles:
      - setup
  setup-database:
    build:
      context: setup/
      target: kong-konga-database-setup
      no_cache: false
    #command: --interactive
    depends_on:
      db:
        condition: service_started
    volumes:
      - ./setup/scripts/database/interactive.js:/app/interactive.js
      - ./setup/scripts/database/modules:/app/modules
    networks:
      - kong-net
    env_file:
      - ./.env.local
    stdin_open: true
    tty: true
    profiles:
      - setup
  setup:
    build:
      context: setup/
      target: kong-konga-configurations-setup
      no_cache: false
    #command: --interactive
    volumes:
      - konga-usr-share-konga-data:/usr/share/konga/data
      - ./setup/scripts/initialSetup/interactive.js:/app/interactive.js
      - ./setup/scripts/initialSetup/modules:/app/modules
      - ./configurations/kong/aditionalConfigurations:/usr/share/kong/aditionalConfigurations
    depends_on:
      kong:
        condition: service_started
      elasticsearch:
        condition: service_started
      kibana:
        condition: service_started
      logstash:
        condition: service_started
    networks:
      - kong-net
    env_file:
      - ./.env.local
    stdin_open: true
    tty: true
    profiles:
      - setup
  konga:
    environment:
      NODE_ENV: development
    depends_on:
      setup:
        condition: service_completed_successfully
    networks:
      - kong-net
    env_file:
      - ./.env.local
    volumes:
      - konga-usr-share-konga-data:/usr/share/konga/data
    profiles:
      - setup
  setup-elk:
    build:
      context: setup/
      target: kong-konga-elk-setup
      no_cache: false
    #command: --interactive
    volumes:
      - ./setup/scripts/elk/interactive.js:/app/interactive.js
      - ./setup/scripts/elk/modules:/app/modules
      - ./configurations/elastic/roles:/usr/share/elastic/roles:ro,Z
      - ./configurations/elastic/users:/usr/share/elastic/users:ro,Z
    networks:
      - kong-net
    depends_on:
      elasticsearch:
        condition: service_started
    env_file:
      - ./.env.local
    profiles:
      - setup
  logstash:
    networks:
      - kong-net
    depends_on:
      setup-elk:
        condition: service_completed_successfully
  kibana:
    networks:
      - kong-net
    depends_on:
      setup-elk:
        condition: service_completed_successfully
  db:
    ports:
      - "5432:5432"
  pgadmin:
    ports:
      - "${PGADMIN_SETUP_EXPOSED_PORT}:${PGADMIN_INTERNAL_LISTEN_PORT}"
